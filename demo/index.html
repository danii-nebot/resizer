<!-- http://www.html5rocks.com/en/tutorials/file/dndfiles/ -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>thumbnail preview demo</title>
    <link rel="stylesheet" href="styles.css">
    <!--  eh -->
    <script>
    var exports = exports || {};
    </script>
    <!--  /eh -->
  </head>
  <body>
    <div class="dropzone" id="dropzone">drop files here for optimized upload</div>
    <div>
      <ul id="list">
      </ul>
    </div>
  </body>

  <script src="./js/resizer.js"></script>
  <!--  exposes URI_DEMO: uri of demo server script -->
  <script src="./js/serverdemo.js"></script>

  <script>
  var list = document.getElementById('list');
  var urlCreator = window.URL || window.webkitURL;

  // setup the dnd listeners
  // TODO: browser support? https://www.sitepoint.com/html5-file-drag-and-drop/
  var dropzone = document.getElementById('dropzone');
  dropzone.ondragover = handleDragOver;
  dropzone.ondrop = handleFileSelect;

  // http://www.lostiemposcambian.com/blog/javascript/guardando-pngs-en-el-servidor-con-html5/
  function sendFile(data, callback) {
    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function() {
      // request complete
      if (xhr.readyState == 4) {
        console.log('ok ' + xhr.responseText);
        callback();
      }
    }

    xhr.open('POST', URI_DEMO, true);
    xhr.setRequestHeader('Content-Type', 'application/upload');
    xhr.send(data);
  }

  function handleFileSelect(e) {
    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files; // FileList object
    var resizer = new Resizer({ maxWidth: 600, thumbSize: 100 });

    // loop through the FileList
    var length = e.dataTransfer.files.length;
    for (var i = 0; i < length; i++) {

      var f = e.dataTransfer.files[i];

      // only process image files
      // TODO: do not process (animated) gifs
      if (!f.type.match('image.*')) {
        continue;
      }

      var reader = new FileReader();

      // closure to capture the file information
      reader.onload = (function(currentFile) {
        return function(e) {
          var img = new Image();
          var blob = new Blob([e.target.result], {type: currentFile.type});

          img.src = urlCreator.createObjectURL(blob); // from blob
          // e.target.result; // this works directly from readAsDataURL

          img.onload = function() {
            setTimeout(function() {
              var li = document.createElement('li');
              li.className += 'thumb';

              var thumb = new Image();
              li.appendChild(thumb);

              var feedbackEl = document.createElement('span');
              feedbackEl.textContent = 'uploading...';
              li.appendChild(feedbackEl);

              // render thumb to DOM
              resizer.getThumbFromImage(img, function(imageData) {
                thumb.src = imageData;
                // '<img class="thumb" src="' + thumb + '" title="' + escape(currentFile.name) + '"/>';
                list.appendChild(li);
              });

              // send resized image to server
              resizer.scaleImage(img, function(imageData) {
                sendFile(imageData, function() {
                  feedbackEl.textContent = 'upload ok!';
                });
              });

            }, 0);
          };
        };
      })(f);

      // read in the image file
      // reader.readAsDataURL(f); // as dataURL (simpler but seems slower - TEST)
      reader.readAsArrayBuffer(f); // as blob
    }
  };

  function handleDragOver(e) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  };

  // TODO: regular boring upload
  // document.getElementById('files').addEventListener('change', handleFileSelect, false);

  // TODO: folder upload
  // https://developers.google.com/web/updates/2012/07/Drag-and-drop-a-folder-onto-Chrome-now-available?hl=en

  // TODO: web workers
  // https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers
  // https://developer.mozilla.org/en-US/docs/Web/API/ImageData
  </script>
</html>
